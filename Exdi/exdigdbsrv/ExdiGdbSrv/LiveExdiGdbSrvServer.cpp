
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
























































































































































































































                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                















































































































































































































































































                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 














































































































































































































































                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
















































































































































































































































                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         






















































































































































































































                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                































































































































































                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          




































































































































































































































E_FAIL;
}

HRESULT STDMETHODCALLTYPE CLiveExdiGdbSrvServer::PerformKeepaliveChecks(void)
{
    if (m_pKeepaliveInterface == nullptr)
    {
        return S_FALSE;
    }

    AsynchronousGdbSrvController * pController = GetGdbSrvController();
    if (pController == nullptr)
    {
        return E_POINTER;
    }

    // Get the GdbServer connection status
    bool isGdbServerDown = false;
    HRESULT gdbServerError = S_OK;;
    if (pController->CheckGdbSrvAlive(gdbServerError))
    {
        if (gdbServerError == ERROR_OPERATION_ABORTED)
        {
            //  Close the connection with the GdbServer
            pController->ShutdownGdbSrv();
            isGdbServerDown = true;
        }
    }

    HRESULT result = m_pKeepaliveInterface->IsDebugSessionAlive();
    if (FAILED(result) || isGdbServerDown)
    {
        TCHAR fileName[MAX_PATH];
        bool lostConnection = ((gdbServerError == ERROR_OPERATION_ABORTED) || HRESULT_FACILITY(result) == FACILITY_WIN32 && 
                              ((HRESULT_CODE(result) == RPC_S_CALL_FAILED) || (HRESULT_CODE(result) == RPC_S_SERVER_UNAVAILABLE)));

        if (lostConnection && GetModuleFileName(GetModuleHandle(0), fileName, _countof(fileName)))
        {
            TCHAR *pLastSlash = _tcsrchr(fileName, '\\');
            if (pLastSlash && !_tcsicmp(pLastSlash + 1, _T("dllhost.exe")))
            {
                ExitProcess(result);
            }
        }
    }
    return S_OK;
}

HRESULT CLiveExdiGdbSrvServer::SetGdbServerParameters()
{
    try
    {
        TCHAR configXmlFile[MAX_PATH + 1];
        DWORD fileNameLength = GetEnvironmentVariable(_T("EXDI_GDBSRV_XML_CONFIG_FILE"), 
                                                      configXmlFile, _countof(configXmlFile));
        if (fileNameLength == 0)
        {
            MessageBox(0, _T("Error: the EXDI_GDBSRV_XML_CONFIG_FILE environment variable is not defined.\n")
                          _T("The Exdi-GdbServer won't continue at this point.\n")
                          _T("Please set the full path to the Exdi xml configuration file."), _T("EXDI-GdbServer"), MB_ICONERROR);
            return E_ABORT;
        }

        ConfigExdiGdbServerHelper & cfgData = ConfigExdiGdbServerHelper::GetInstanceCfgExdiGdbServer(configXmlFile);
        m_targetProcessorArch = cfgData.GetTargetArchitecture();
        m_detectedProcessorFamily = cfgData.GetTargetFamily();
        m_fDisplayCommData = cfgData.GetDisplayCommPacketsCharacters();
        m_fEnableSSEContext = cfgData.GetIntelSseContext();
        m_heuristicChunkSize = cfgData.GetHeuristicScanMemorySize();
        unsigned numberOfCores = cfgData.GetNumberOfCores();
        std::vector<std::wstring> coreConnections;
        cfgData.GetGdbServerConnectionParameters(coreConnections);
        if (coreConnections.size() != numberOfCores)
        {
            MessageBox(0, _T("Error: the number of cores does not match with the number of connection strings in the configuration xml file."),
                       _T("EXDI-GdbServer"), MB_ICONERROR);
            return E_ABORT;
        }

        m_pGdbSrvController = AsynchronousGdbSrvController::Create(coreConnections);
        m_pGdbSrvController->SetTargetArchitecture(m_targetProcessorArch);
        m_pGdbSrvController->SetTargetProcessorFamilyByTargetArch(m_targetProcessorArch);
        if (m_fDisplayCommData)
        {
            m_pGdbSrvController->SetTextHandler(new CommandLogger(true));
        }

        WCHAR systemRegMapXmlFile[MAX_PATH + 1];
        fileNameLength = GetEnvironmentVariable(_T("EXDI_SYSTEM_REGISTERS_MAP_XML_FILE"),
            systemRegMapXmlFile, _countof(systemRegMapXmlFile));
        if (fileNameLength != 0)
        {
            m_pGdbSrvController->SetSystemRegisterXmlFile(systemRegMapXmlFile);
        }
        else
        {
            MessageBox(0, _T("Error: the EXDI_SYSTEM_REGISTERS_MAP_XML_FILE environment variable is not defined.\n")
                _T("rdmsr/wrmsr functions won't work at this point.\n")
                _T("Please set the full path to the SYSTEMREGISTERS.XML file."), _T("EXDI-GdbServer"), MB_ICONERROR);
        }

        return S_OK;
    }
    CATCH_AND_RETURN_HRESULT;
}

DWORD CALLBACK CLiveExdiGdbSrvServer::NotificationThreadBody(LPVOID p)
{
    CLiveExdiGdbSrvServer * pServer = reinterpret_cast<CLiveExdiGdbSrvServer *>(p);
    AsynchronousGdbSrvController * pController = pServer->GetGdbSrvController();
    assert(pController != nullptr);

    HRESULT result = CoInitialize(nullptr);
    assert(SUCCEEDED(result));
    UNREFERENCED_PARAMETER(result);

    ConfigExdiGdbServerHelper & cfgData = ConfigExdiGdbServerHelper::GetInstanceCfgExdiGdbServer(nullptr);
    DWORD waitTimeout = (cfgData.GetMultiCoreGdbServer()) ? INFINITE : 6000;  

    for (;;)
    {
        DWORD waitResult = WaitForSingleObject(pServer->m_notificationSemaphore, 100);

        if (pServer->m_terminating)
        {
            break;
        }

        assert(pServer->m_pSelfReferenceForNotificationThread != nullptr);

        IAsynchronousCommandNotificationReceiver *pReceiver  =
            pServer->m_pSelfReferenceForNotificationThread->TryUnmarshalInterfaceForCurrentThread();

        if (!pServer->m_terminating)
        {
            if (pReceiver == nullptr)
            {
                throw new std::exception("Cannot send any requests to the main COM thread");
            }

            pReceiver->PerformKeepaliveChecks();

            if (waitResult == WAIT_OBJECT_0)
            {
                if (pController->GetAsynchronousCommandResult(waitTimeout, nullptr))
                {
                    pReceiver->OnAsynchronousCommandCompleted();
                }
            }
        }

        if (pReceiver != nullptr)
        {
            pReceiver->Release();
        }
    }

    CoUninitialize();
    return 0;
}

VOID CALLBACK CLiveExdiGdbSrvServer::TimerCallback(_In_  HWND hwnd, _In_  UINT uMsg, _In_  UINT_PTR idEvent, _In_  DWORD dwTime)
{
    UNREFERENCED_PARAMETER(hwnd);
    UNREFERENCED_PARAMETER(uMsg);
    UNREFERENCED_PARAMETER(idEvent);
    UNREFERENCED_PARAMETER(dwTime);
    //  If your JTAG hardware supports polling mode rather than asynchronous notification mode, use this
    //  method to poll whether the target has stopped on an event and send a notification to debugging engine
    //  by calling m_pRunNotificationListener->NotifyRunStateChange().
}

HRESULT CLiveExdiGdbSrvServer::SetGdbServerConnection(void)
{
    try
    {
        AsynchronousGdbSrvController * pController = GetGdbSrvController();
        if (pController == nullptr)
        {
            return E_POINTER;
        }

        //  Configure the GdbServer communication session.
        if (!pController->ConfigureGdbSrvCommSession(m_fDisplayCommData, C_ALLCORES))
        {
            //  Failed configuring the session.
            MessageBox(0, _T("Error: Unable to configure the GdbServer session."), _T("EXDI-GdbServer"), MB_ICONERROR);
            return E_ABORT;
        }

        //  Execute the connection to the GdbServer
        if (!pController->ConnectGdbSrv())
        {
            //  Failed connecting to the GdbServer.
            MessageBox(0, _T("Error: Unable to establish a connection with the GdbServer.")
                          _T("Please verify the connection string <hostname/ip>:portnumber."),
                          _T("EXDI-GdbServer"), MB_ICONERROR);
            return E_ABORT;
        }

        HRESULT result = E_FAIL;

        //  Establish the handshaking with the GdbServer.
        //  Request the set of features supported by the GdbServer
        if (pController->ReqGdbServerSupportedFeatures())
        {
            //  Ensure that the target architecture matches with the current GDB server
            m_targetProcessorArch = m_pGdbSrvController->GetTargetArchitecture();
            m_detectedProcessorFamily = m_pGdbSrvController->GetProcessorFamilyArchitecture();
            //  Is the target broken because the GdbServer sends a break request?
            if (pController->IsTargetHalted())
            {
                result = S_OK;
            }
        }
        return result;
    }
    CATCH_AND_RETURN_HRESULT;
}

ADDRESS_TYPE CLiveExdiGdbSrvServer::ParseAsynchronousCommandResult(_Out_ DWORD * pProcessorNumberOfLastEvent, _Out_ HALT_REASON_TYPE * pHaltReason)
{
    assert(pProcessorNumberOfLastEvent != nullptr);
    AsynchronousGdbSrvController * pController = GetGdbSrvController();
    assert(pController != nullptr);

    ADDRESS_TYPE currentPcAddress = 0;
    if (pController->GetAsynchronousCmdStopReplyPacket())
    {
        int attempts = 0;
        bool isWaitingOnStopReply = false;
        ULONG totalPackets = 0;
        do
        {
            StopReplyPacketStruct stopReply = {0};
            const std::string reply = pController->GetCommandResult();
            bool isParsed = pController->HandleAsynchronousCommandResponse(reply, &stopReply);
            if (isParsed)
            {
                attempts = 0;
                //  Is it a OXX console packet? 
                if (stopReply.status.isOXXPacket)
                {
                    //  Try to display the GDB server ouput message if there is an attached text console.
                    pController->DisplayConsoleMessage(reply);
                    //  Post another receive request on the packet buffer
                    pController->ContinueWaitingOnStopReplyPacket();
                    isWaitingOnStopReply = true;
                }
                //  Is it a T packet?
                else if (stopReply.status.isTAAPacket)
                {
                    if (stopReply.status.isPcRegFound)
                    {
                        assert(stopReply.currentAddress != 0);
                        currentPcAddress = m_lastPcAddress = stopReply.currentAddress;
                    }
                    else
                    {
                        //  The packet didn't contain the PC, but we'd better find out what it is, so we can inform the debugger
                        DWORD pcAddressRequest;
                        currentPcAddress = m_lastPcAddress = GetCurrentExecutionAddress(&pcAddressRequest);
                    }

                    if (stopReply.status.isThreadFound)
                    {
                        assert(stopReply.processorNumber != static_cast<ULONG>(-1));
                        if (stopReply.processorNumber <= pController->GetProcessorCount())
                        {
                            *pProcessorNumberOfLastEvent = stopReply.processorNumber;
                        }
                    }
                    else
                    {
                        *pProcessorNumberOfLastEvent = pController->GetLastKnownActiveCpu();
                    }
                    isWaitingOnStopReply = false;
                }
                //  Is it a S AA packet?
                else if (stopReply.status.isSAAPacket)
                {
                    //  There is a no any processor number or pc adddress in the response
                    if (stopReply.status.isPowerDown)
                    {
                        MessageBox(0, _T("The Target is running or it is in a power down state."),nullptr, MB_ICONERROR);                    
                    }
                    stopReply.currentAddress = m_lastPcAddress;
                    *pProcessorNumberOfLastEvent = pController->GetLastKnownActiveCpu();
                    isWaitingOnStopReply = false;
                } 
                // Is it an "OK" response w/o any other field (e.g. OpenOCD can send "OK" after 's'/'g')?
                else if (stopReply.status.isCoreRunning)
                {
                    //  Post another receive request on the packet buffer, since there is still no
                    //  trace of the current thread-core/Pc address packet.
                    pController->ContinueWaitingOnStopReplyPacket();
                    isWaitingOnStopReply = true;                
                }

                if (!isWaitingOnStopReply)
                {
                    //  Convert the stop reason code
                    switch (stopReply.stopReason) 
                    {
                    case TARGET_BREAK_SIGINT:
                       *pHaltReason = hrUser;
                       break;
                    case TARGET_BREAK_SIGTRAP:
                       *pHaltReason = hrBp;
                       break;
                    default:
                       *pHaltReason = hrUnknown;
                    }
                    pController->ResetAsynchronousCmdStopReplyPacket();
                }
            }
            else
            {
                Sleep(c_asyncResponsePauseMs);
            }
        }
        while (isWaitingOnStopReply &&
            (attempts++ < c_attemptsWaitingOnPendingResponse) &&
            (totalPackets < c_maximumReplyPacketsInResponse));
    }
    else
    {
        //  This can happen only if there was a previously handled Halt event.
        currentPcAddress = m_lastPcAddress;
    }
    return currentPcAddress;
}

void CLiveExdiGdbSrvServer::GetX86CoreRegisters(_In_ std::map<std::string, std::string> &registers, 
                                                      _Out_ CONTEXT_X86_EX * pContext)
{
    assert(pContext != nullptr);

    pContext->Eax = GdbSrvController::ParseRegisterValue32(registers["Eax"]);
    pContext->Ebx = GdbSrvController::ParseRegisterValue32(registers["Ebx"]);
    pContext->Ecx = GdbSrvController::ParseRegisterValue32(registers["Ecx"]);
    pContext->Edx = GdbSrvController::ParseRegisterValue32(registers["Edx"]);
    pContext->Esi = GdbSrvController::ParseRegisterValue32(registers["Esi"]);
    pContext->Edi = GdbSrvController::ParseRegisterValue32(registers["Edi"]);
    pContext->Eip = GdbSrvController::ParseRegisterValue32(registers["Eip"]);
    m_lastPcAddress = pContext->Eip;
    pContext->Esp = GdbSrvController::ParseRegisterValue32(registers["Esp"]);
    pContext->Ebp = GdbSrvController::ParseRegisterValue32(registers["Ebp"]);
    pContext->EFlags = GdbSrvController::ParseRegisterValue32(registers["EFlags"]);
    pContext->RegGroupSelection.fIntegerRegs = TRUE;

    pContext->SegCs = static_cast<DWORD>(GdbSrvController::ParseRegisterValue32(registers["SegCs"]));
    pContext->SegSs = static_cast<DWORD>(GdbSrvController::ParseRegisterValue32(registers["SegSs"]));
    pContext->RegGroupSelection.fControlRegs = TRUE;

    pContext->SegDs = static_cast<DWORD>(GdbSrvController::ParseRegisterValue32(registers["SegDs"]));
    pContext->SegEs = static_cast<DWORD>(GdbSrvController::ParseRegisterValue32(registers["SegEs"]));
    pContext->SegFs = static_cast<DWORD>(GdbSrvController::ParseRegisterValue32(registers["SegFs"]));
    pContext->SegGs = static_cast<DWORD>(GdbSrvController::ParseRegisterValue32(registers["SegGs"]));
    pContext->RegGroupSelection.fSegmentRegs = TRUE;
}

void CLiveExdiGdbSrvServer::GetFPCoprocessorRegisters(_In_ std::map<std::string, std::string> &registers,
                                                            _In_ DWORD processorNumber, 
                                                            _In_ AsynchronousGdbSrvController * const pController,
                                                            _Out_ PVOID pContext)
{
    assert(pContext != nullptr);

    PCONTEXT_X86_EX pContextFP = reinterpret_cast<PCONTEXT_X86_EX>(pContext);

    pContextFP->ControlWord = static_cast<DWORD>(GdbSrvController::ParseRegisterValue32(registers["ControlWord"]));
    pContextFP->StatusWord = static_cast<DWORD>(GdbSrvController::ParseRegisterValue32(registers["StatusWord"]));
    pContextFP->TagWord = static_cast<DWORD>(GdbSrvController::ParseRegisterValue32(registers["TagWord"]));
    pContextFP->ErrorOffset = static_cast<DWORD>(GdbSrvController::ParseRegisterValue32(registers["ErrorOffset"]));
    pContextFP->ErrorSelector = static_cast<DWORD>(GdbSrvController
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 













































































































































































      if (pFunctionToExecute == nullptr)
        {
            return E_POINTER;
        }
        if (type != exdiComponentSession)
        {
            return E_INVALIDARG;
        }
        AsynchronousGdbSrvController * pController = GetGdbSrvController();
        if (pController == nullptr)
        {
            return E_POINTER;
        }
        if (!pController->ExecuteExdiFunction(dwProcessorNumber, pFunctionToExecute))
        {
            return E_FAIL;
        }
        return S_OK;
    }
    CATCH_AND_RETURN_HRESULT;
}

HRESULT STDMETHODCALLTYPE CLiveExdiGdbSrvServer::ExecuteTargetEntityFunction( 
    /* [in] */ ExdiComponentFunctionType type,
    /* [in] */ DWORD dwProcessorNumber,
    /* [in] */ LPCWSTR pFunctionToExecute,
    /* [out] */ SAFEARRAY ** pFunctionResponseBuffer)
{
    try
    {
        if (pFunctionToExecute == nullptr)
        {
            return E_POINTER;
        }
        if (type != exdiTargetEntity || dwProcessorNumber == C_ALLCORES)
        {
            return E_INVALIDARG;
        }
        AsynchronousGdbSrvController * pController = GetGdbSrvController();
        if (pController == nullptr)
        {
            return E_POINTER;
        }
        SimpleCharBuffer buffer = pController->ExecuteExdiGdbSrvMonitor(dwProcessorNumber, pFunctionToExecute);
        return SafeArrayFromByteArray(buffer.GetInternalBuffer(), buffer.GetLength(), pFunctionResponseBuffer);
    }
    CATCH_AND_RETURN_HRESULT;
}
